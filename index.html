<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>OrderProduct</title>
    <link rel="stylesheet" href="bootstrap.css" />
    <link rel="stylesheet" href="style.css" />
  </head>
  <body>
    <div class="container-fluid">
      <div class="row">
        <div class="col-7">
          <div class="row" id="main_product_card"></div>
        </div>
        <div class="col-lg-5">
          <div class="card product-card">
            <div class="card-header">Select Product</div>
            <div class="card-body">
              <div class="table-responsive">
                <table class="table table-borderless table-striped">
                  <thead class="bg-primary text-white">
                    <tr>
                      <th>No.</th>
                      <th>Product Name</th>
                      <th>Price</th>
                      <th>Qty</th>

                      <th>Total</th>
                      <th>Action</th>
                    </tr>
                  </thead>
                  <tbody id="create_product_tr"></tbody>
                </table>
              </div>
            </div>
            <div class="card-foodter">
              <table class="table table-bordered">
                <thead>
                  <tr>
                    <th><h3>Total</h3></th>
                    <th class="text-right">
                      <h3 id="total_usa">$</h3>
                      <h3 id="total_khr">៛</h3>
                    </th>
                  </tr>
                  <tr>
                    <th><h3>Receive</h3></th>
                    <th>
                      <input
                        onkeyup="getChange()"
                        type="number"
                        id="receive_usa"
                        placeholder="$"
                      />
                    </th>
                  </tr>
                  <tr>
                    <th><h3>Change</h3></th>
                    <th
                      class="bg-warning text-white"
                      id="change_label"
                      style="display: none"
                    >
                      <h3 class="text-right" id="change_usa"></h3>
                    </th>
                  </tr>
                  <tr>
                    <th id="cancel" onclick="cancel()">Cancel</th>
                    <th id="payment" onclick="payment()">Pay Now</th>
                  </tr>
                </thead>
              </table>
            </div>
          </div>
        </div>
      </div>
    </div>
  </body>
  <script src="main.js"></script>
  <script>
    let main_product_card = document.getElementById("main_product_card");
    let product_list = JSON.parse(localStorage.getItem("product_list")) ?? [];
    let selete_product_card = [];
    let create_product_tr = document.getElementById("create_product_tr");
    let receive_usa = document.getElementById("receive_usa");
    let change_usa = document.getElementById("change_usa");

    let total = 0;
    let cart = [];
    renderCard();
    function renderCard() {
      let new_card = "";
      product_list.forEach((product, index) => {
        new_card += `
         <div class="col-lg-3 " onclick="OnclickCard(${index})">
              <div class="card product-card">
                <center><img src="${product.value_imageURL}" alt="coca-cola" / class="mt-3"></center>
                <div class="card-body">
                  <div class="card-title">${product.value_name}</div>
                  <div class="card-text">${product.value_price}$</div>
                </div>
              </div>
            </div>
        `;
      });
      main_product_card.innerHTML = new_card;
    }

    function OnclickCard(index) {
      let selete_card = product_list[index];
      let dpl_index = null;
      for (let i = 0; i < selete_product_card.length; i++) {
        if (selete_card.value_name == selete_product_card[i].value_name) {
          dpl_index = i;
          break;
        }
      }
      if (dpl_index !== null) {
        selete_product_card[dpl_index].quantity += 1;
      } else {
        selete_card.quantity = 1;
        selete_product_card.push(selete_card);
      }

      renderTable();
      totalAmount();
    }

    function renderTable() {
      let new_card_table = "";

      selete_product_card.forEach((product, index) => {
        total = product.value_price * product.quantity;
        new_card_table += `
         <tr>
              <td>${index + 1}</td>
              <td>${product.value_name}</td>
              <td>${product.value_price} $</td>
              <td>${product.quantity}</td>             
              <td>${total} $</td>
              <td>
                  <button value="Remove" onclick="deleteProduct(${index})" id="remove">❌</button>
              </td>
             
          </tr>
        `;
      });
      create_product_tr.innerHTML = new_card_table;
    }
    function deleteProduct(index) {
      let check_confirm = confirm("Are you sure to delete this product");
      if (check_confirm) {
        selete_product_card.splice(index, 1);
        renderTable();
      }
      totalAmount();
      receive_usa.value = "";
      change_usa.innerText = "";
    }
    function totalAmount() {
      total = 0;
      selete_product_card.forEach((product, index) => {
        total += product.value_price * product.quantity;
      });
      document.getElementById("total_usa").innerText = " $ " + total.toFixed(2);
      document.getElementById("total_khr").innerText =
        "៛ " + (total * 4100).toFixed(2);
    }
    function payment() {
      if (receive_usa.value < total) {
        alert("Recieved must be greater than total");
        return;
      }
      localStorage.setItem(
        "selete_product_card",
        JSON.stringify(selete_product_card)
      );
      let width = 600;
      let height = 600;
      let left = (window.screen.width - width) / 2;
      let top = (window.screen.height - height) / 2;
      window.open(
        "invoice.html",
        "_blank",
        `width=600,height=600,
     left=${left},
     top=${top}`
      );
    }
    function getChange() {
      let change_amount = parseFloat(receive_usa.value) - parseFloat(total);
      change_usa.innerText = "$ " + (receive_usa.value - total).toFixed(2);
      if (change_amount > 0) {
        document.getElementById("change_label").style.display = "block";
      } else {
        document.getElementById("change_label").style.display = "none";
      }
    }
    function cancel() {
      let check_confirm = confirm("Are you sure to delete all product");
      if (check_confirm) {
        selete_product_card = [];
        renderTable();
        totalAmount();
      }
      receive_usa.value = "";
      change_usa.innerText = "";
      document.getElementById("change_label").style.display = "none";
    }
  </script>
</html>
